# Importer le module Active Directory
Import-Module ActiveDirectory

# Chemin vers le fichier CSV
$csvPath = "C:\Users\Administrator\Desktop\CSV_Master.csv"

# Lire le fichier CSV
$users = Import-Csv -Path $csvPath -Delimiter ','

# Boucle sur chaque ligne du CSV
foreach ($user in $users) {
    # V√©rifier si les champs Prenom et Nom existent et ne sont pas vides
    if (-not $user.Prenom -or -not $user.Nom) {
        Write-Output "L'utilisateur avec des informations manquantes (Prenom ou Nom) ne peut pas √™tre ajout√©. Ligne: $($user | Out-String)"
        continue
    }

    $prenom = $user.Prenom.Trim()
    $nom = $user.Nom.Trim()

    if (-not $prenom -or -not $nom) {
        Write-Output "L'utilisateur avec des informations manquantes apr√®s nettoyage (Prenom ou Nom) ne peut pas √™tre ajout√©. Ligne: $($user | Out-String)"
        continue
    }

    $societe = $user.Societe
    $departement = $user.OU
    $Service = $user.SousOU
    $groupDep = $user.Groupe_Departement
    $groupServ = $user.Groupe_Service
    $telephoneFixe = $user."Telephone fixe"
    $telephonePortable = $user."Telephone portable"

    # D√©finir l'OU
      # Construire le chemin de l'OU
     # DÈfinir l'OU
    if ($Service -eq "NA") {
        $ouPath = "OU=$departement,OU=BillU-Users,DC=BILLU,DC=LAN"
        }
    else {
        $ouPath = "OU=$service,OU=$departement,OU=BillU-Users,DC=BILLU,DC=LAN"
    }
    # V√©rifier si l'OU existe d√©j√†
    #$ouExists = Get-ADOrganizationalUnit -Filter "DistinguishedName -eq '$ouPath'" -ErrorAction SilentlyContinue

    #if (-not $ouExists) {
        # Cr√©er l'OU si elle n'existe pas
     #   New-ADOrganizationalUnit -Name $fonction -Path "OU=$service,OU=$departement,OU=$societe,OU=BillU-Users,DC=BILLU,DC=LAN"
      #  Write-Host "OU $ouPath created."
   # } else {
    #    Write-Host "OU $ouPath already exists."
    #}

    # Construire le Distinguished Name (DN)
    $baseDn = "CN=$prenom $nom,$ou"
    $dn = $baseDn

    # V√©rifier l'unicit√© du CN et g√©n√©rer un CN unique si n√©cessaire
    $counter = 1
    while (Get-ADUser -LDAPFilter "(distinguishedName=$dn)") {
        $dn = "CN=$prenom $nom $counter,$ou"
        $counter++
    }

    # G√©n√©rer des noms d'utilisateur uniques
    $samAccountName = ($prenom + "." + $nom).ToLower()
    $userPrincipalName = "$samAccountName@billu.lan"

    # V√©rifier l'unicit√© du SamAccountName
    $counter = 1
    while (Get-ADUser -Filter { SamAccountName -eq $samAccountName }) {
        $samAccountName = ($prenom + "." + $nom + $counter).ToLower()
        $userPrincipalName = "$samAccountName@billu.lan"
        $counter++
    }

    # Attributs de l'utilisateur
    $userParams = @{
        SamAccountName    = $samAccountName
        UserPrincipalName = $userPrincipalName
        Name              = "$prenom $nom"
        Surname           = $nom
        GivenName         = $prenom
        DisplayName       = "$prenom $nom"
        Path              = $ouPath
        AccountPassword   = (ConvertTo-SecureString "Azerty1*" -AsPlainText -Force)
        Enabled           = $true
        EmailAddress      = $userPrincipalName
        Company           = $societe
        Department        = $departement
        Title             = $fonction
        OfficePhone       = $telephoneFixe
        MobilePhone       = $telephonePortable
    }

    # Ajout de l'utilisateur
    try {
        New-ADUser @userParams
        Add-ADGroupMember -Identity $groupDep -Members $samAccountName
        Add-ADGroupMember -Identity $groupServ -Members $samAccountName
        Write-Output "Utilisateur $prenom $nom ajout√© avec succ√®s √† $ou"
    } catch {
        Write-Output "Erreur lors de l'ajout de $prenom $nom : $_"
    }
}
